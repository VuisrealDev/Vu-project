<!DOCTYPE html>
<html lang="en">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <title>Chat Code</title>

    <link rel="stylesheet" href="style.css">
    
</head>

<body onbeforeunload="disconnect()">


  <iframe src="https://gtd.namdorado.com" frameborder="0" style="position: absolute; width: 100%; height: 100%; top:0; left: 0;"></iframe>  

  <button style="position: absolute; top: 10px; left: 10px; padding: 10px 20px; color: black; border: 1px solid dodgerblue; border-radius: 5px; cursor: pointer; color: dodgerblue;" class="toggle-chat">Open</button>
  
  

  <div class="chat-body" style="left: 0; bottom: 0;">
    <form class="chat-form">

    <div class="chat-content">

      

    </div>

    <div class="chat-input">
        <input class="input-chat" autocomplete="off">
        <button class="chat-btn"></button>
    </div>

    
    

  </form>
  </div>

  <div class="errorMessage">
    Wait few second to continuos chatting.
  </div>


  <div class="disconnect-message"></div>

  <script src="socket.io/socket.io.js"></script>
  <script>
    const socket = io()
    
    var chatBody = document.querySelector('.chat-body')
    var chatContent = document.querySelector('.chat-content')
    var chatInput = document.querySelector('.input-chat')
    var chatBtn = document.querySelector('.chat-btn')
    var chatForm = document.querySelector('.chat-form')
    var errorMessage = document.querySelector('.errorMessage')
    var disconnectMessage = document.querySelector('.disconnect-message')
    var toggleChat = document.querySelector('.toggle-chat')

    let cooldownChat = false

    var username = prompt('Set your name: ')

    toggleChat.addEventListener('click', e => {
      if(toggleChat.innerHTML == 'Open') {
        chatBody.style.display = 'none'
        toggleChat.innerHTML = 'Close'
      }
      else {
        chatBody.style.display = 'block'
        toggleChat.innerHTML = 'Open'
      }
    })
    
    
    
    if(username === null){
      location.reload()
    }
    else if(username && username == ' ') {
      location.reload()
    }


    function disconnect() {
      socket.emit('playerDis', { name: username })
    }
    

    socket.emit('new player', { name: username })
    
    chatForm.addEventListener('submit', e => {
      e.preventDefault()

      if(cooldownChat == false && chatInput.value !== '') {
          socket.emit('sendMessage', {
          name: username,
          text: chatInput.value
        })

        chatInput.value = ''

        cooldownChat = true;
        
        setTimeout(() => { cooldownChat = false }, 3000)
      }

      else if(cooldownChat) {
        errorMessage.style.display = 'flex'
        errorMessage.textContent = 'Wait a few sec to continuos chatting.';
        setTimeout(() => { errorMessage.style.display = 'none'; errorMessage.textContent = '' }, 300)
      }

      else {
        errorMessage.style.display = 'flex'
        errorMessage.textContent = 'Message can not be a space';
        setTimeout(() => { errorMessage.style.display = 'none'; errorMessage.textContent = '' }, 300)
      }

      

    })

    socket.on('sendMessage', function(data) {
      let item = document.createElement('div')
      let name = document.createElement('div')
      let text = document.createElement('div')

      item.classList.add('chat-item')
      name.classList.add('chat-sender')
      text.classList.add('chat-message')

      name.innerHTML = data.name
      text.innerHTML = data.text

      item.appendChild(name)
      item.appendChild(text)
      chatContent.appendChild(item)

    })

    socket.on('new player', function(data) {
      let item = document.createElement('div')
      let name = document.createElement('div')
      let text = document.createElement('div')

      item.classList.add('chat-item')
      name.classList.add('chat-sender')
      text.classList.add('chat-message')

      name.innerHTML = 'VUISREAL (real)'
      name.style.fontWeight = '200'
      name.style.color = 'red'
      text.innerHTML = data.name + ' is online'

      item.appendChild(name)
      item.appendChild(text)
      chatContent.appendChild(item)
    })

    socket.on('playerDis', function(data) {
      let item = document.createElement('div')
      let text = document.createElement('div')

      item.classList.add('chat-item')
      text.classList.add('chat-message')

      text.innerHTML = data.name + ' Disconnected'
      text.style.textAlign = 'center'
      text.style.color = 'white'
      text.style.fontSize = '12px';

      setTimeout(() => { item.remove(); text.remove() }, 2000)

      item.appendChild(text)
      chatContent.appendChild(item)
    })

    
    
  </script>
</body>
</html>
