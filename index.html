<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
    <link rel="stylesheet" href="style.css" />
  </head>
  <body>
    <button class="active-chat-of-btn1">Bật/Tắt Chat</button>

    <div class="chat-body">
      <div class="chat-content"></div>
      <div class="chat-input">
        <input type="text" id="input-chat" autocomplete="off" maxlength="32" />
        <button class="btn-chat" onclick="do_send_chat()"></button>
      </div>
    </div>

    <canvas id="canvas" tabindex="1"></canvas>

    <script src="socket.io/socket.io.js"></script>

    <script>
      const socket = io();

      var chatBody = document.querySelector(".chat-body");
      var chatContent = document.querySelector(".chat-content");
      var inp = document.querySelector("#input-chat");
      var btnChat = document.querySelector(".btn-chat");
      var actChat = document.querySelector(".active-chat-of-btn1");

      var btnChatActived = true;

      const canvas = document.getElementById("canvas");
      const ctx = canvas.getContext("2d");

      canvas.width = innerWidth;
      canvas.height = innerHeight;

      let players = {};
      let playerId;
      const keys = {};

      canvas.addEventListener("keydown", (event) => {
        keys[event.code] = true;
      });

      canvas.addEventListener("keyup", (event) => {
        keys[event.code] = false;
      });

      socket.on("currentPlayers", (currentPlayers) => {
        players = currentPlayers;
        playerId = socket.id;
      });

      socket.on("newPlayer", (player) => {
        players[player.id] = player;
      });

      socket.on("playerMoved", (player) => {
        players[player.id] = player;
      });

      socket.on("disconnected", (id) => {
        delete players[id];
      });

      function update() {
        const movementData = { x: 0, y: 0 };

        if (keys["KeyW"]) movementData.y = -5;
        if (keys["KeyS"]) movementData.y = 5;
        if (keys["KeyA"]) movementData.x = -5;
        if (keys["KeyD"]) movementData.x = 5;

        if (movementData.x !== 0 || movementData.y !== 0) {
          socket.emit("playerMovement", movementData);
        }
      }

      function draw() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);

        for (let id in players) {
          const player = players[id];
          ctx.fillStyle = "dodgerblue";
          ctx.beginPath();
          ctx.arc(player.x, player.y, 20, 0, Math.PI * 2);
          ctx.fill();
        }
      }

      function gameLoop() {
        update();
        draw();
        requestAnimationFrame(gameLoop);
      }

      gameLoop();

      actChat.addEventListener("click", (e) => {
        if (btnChatActived) {
          chatBody.style.display = "none";
          btnChatActived = false;
        } else {
          chatBody.style.display = "block";
          btnChatActived = true;
        }
      });

      var user = prompt("Enter your name: ");

      if (user === "") {
        location.reload();
      } else if (!user) {
        location.reload();
      } else if (user == " ") {
        location.reload();
      } else if (user && user != "") {
        socket.emit("userConnected", { username: user });
        socket.emit("currentPlayers", players);
        socket.emit("newPlayer", { id: socket.id, ...players[socket.id] });
      }

      function do_send_chat() {
        socket.emit("sendChat", { username: user, message: inp.value });
      }

      inp.addEventListener("keydown", (e) => {
        if (e.code == "Enter" && inp.value) {
          do_send_chat();
          inp.value = "";
        }
      });

      btnChat.addEventListener("click", () => {
        do_send_chat();
        inp.value = "";
      });

      socket.on("userConnected", function (data) {
        let item = document.createElement("div");
        let sender = document.createElement("div");
        let message = document.createElement("div");

        item.classList.add("chat-item");
        sender.classList.add("chat-sender");
        message.classList.add("chat-message");

        sender.innerText = "VUISREAL (real)";
        message.textContent = "Tài khoản " + data.username + " vừa đăng nhập";

        sender.style.color = "red";

        item.append(sender);
        item.append(message);

        chatContent.appendChild(item);
      });

      socket.on("sendChat", function (data) {
        let item = document.createElement("div");
        let sender = document.createElement("div");
        let message = document.createElement("div");

        item.classList.add("chat-item");
        sender.classList.add("chat-sender");
        message.classList.add("chat-message");

        sender.innerText = data.username;
        message.innerHTML = data.message;

        item.append(sender);
        item.append(message);

        let text = "" + data.message;

        chatContent.appendChild(item);
      });
    </script>
  </body>
</html>
