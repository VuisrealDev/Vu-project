<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
    <link rel="stylesheet" href="style.css" />
  </head>
  <body>

    <canvas id="canvas" width="500" height="500">
      Your Browser Does Not Support Canvas and HTML5
    </canvas>

    <script src="socket.io/socket.io.js"></script>
    <script src="engine.js"></script>
    <script>
      const socket = io();

      var canvas = document.getElementById("canvas"),
        ctx = canvas.getContext("2d"),
        W = window.innerWidth,
        H = window.innerHeight;

      var keys = {};

      window.addEventListener(
        "keydown",
        function (e) {
          keys[e.code] = true;
        },
        false
      );

      //check if key is not being pressed or has lifted up
      window.addEventListener(
        "keyup",
        function (e) {
          delete keys[e.code];
        },
        false
      );

      //game loop to make the game smoother
      function gameLoop() {
        if (keys['KeyA']) {
          socket.emit("pressed", 'keyA');
        }
        if (keys['KeyW']) {
          socket.emit("pressed", 'keyW');
        }
        if (keys['KeyS']) {
          socket.emit("pressed", 'keyS');
        }
        if (keys['KeyD']) {
          socket.emit("pressed", 'keyD');
        }
        window.requestAnimationFrame(gameLoop);
      }
      window.requestAnimationFrame(gameLoop);

      //the connected user joins and gets all the players on server
      socket.on("welcome", function (currentUser, currentUsers) {

        ctx.globalCompositeOperation = "source-over";
        //Lets reduce the opacity of the BG paint to give the final touch
        ctx.clearRect(0,0,W,H)

        //Lets blend the particle with the BG
        ctx.globalCompositeOperation = "lighter";

        //players in lobby
        for (var i = 0; i < currentUsers.length; i++) {
          ctx.beginPath();

          //Time for some colors
          var gradient = ctx.createRadialGradient(
            currentUsers[i].x,
            currentUsers[i].y,
            0,
            currentUsers[i].x,
            currentUsers[i].y,
            currentUsers[i].radius
          );
          gradient.addColorStop(0, "white");
          gradient.addColorStop(0.4, "white");
          gradient.addColorStop(0.4, currentUsers[i].color);
          gradient.addColorStop(1, "black");

          ctx.fillStyle = 'red';
          ctx.arc(
            currentUsers[i].x,
            currentUsers[i].y,
            currentUsers[i].radius,
            Math.PI * 2,
            false
          );
          ctx.fill();
        }

        //player
        ctx.beginPath();
        //Time for some colors
        var gradient = ctx.createRadialGradient(
          currentUser.x,
          currentUser.y,
          0,
          currentUser.x,
          currentUser.y,
          currentUser.radius
        );
        gradient.addColorStop(0, "white");
        gradient.addColorStop(0.4, "white");
        gradient.addColorStop(0.4, currentUser.color);
        gradient.addColorStop(1, "black");

        ctx.fillStyle = 'red';
        ctx.arc(
          currentUser.x,
          currentUser.y,
          currentUser.radius,
          Math.PI * 2,
          false
        );
        ctx.fill();
      });

      //other users get updated with new players when teh new player joins
      socket.on("currentUsers", function (currentUsers) {
        ctx.globalCompositeOperation = "source-over";
        //Lets reduce the opacity of the BG paint to give the final touch
        ctx.clearRect(0,0,W,H)

        //Lets blend the particle with the BG
        ctx.globalCompositeOperation = "lighter";

        for (var i = 0; i < currentUsers.length; i++) {
          ctx.beginPath();

          //Time for some colors
          var gradient = ctx.createRadialGradient(
            currentUsers[i].x,
            currentUsers[i].y,
            0,
            currentUsers[i].x,
            currentUsers[i].y,
            currentUsers[i].radius
          );
          gradient.addColorStop(0, "white");
          gradient.addColorStop(0.4, "white");
          gradient.addColorStop(0.4, currentUsers[i].color);
          gradient.addColorStop(1, "black");

          ctx.fillStyle = 'red';
          ctx.arc(
            currentUsers[i].x,
            currentUsers[i].y,
            currentUsers[i].radius,
            Math.PI * 2,
            false
          );
          ctx.fill();
        }
      });

      //if a player leaves, everyone gets new set of players
      socket.on("playerLeft", function (currentUsers) {
        ctx.globalCompositeOperation = "source-over";
        //Lets reduce the opacity of the BG paint to give the final touch
        ctx.clearRect(0,0,W, H)

        //Lets blend the particle with the BG
        ctx.globalCompositeOperation = "lighter";

        for (var i = 0; i < currentUsers.length; i++) {
          ctx.beginPath();

          //Time for some colors
          var gradient = ctx.createRadialGradient(
            currentUsers[i].x,
            currentUsers[i].y,
            0,
            currentUsers[i].x,
            currentUsers[i].y,
            currentUsers[i].radius
          );
          gradient.addColorStop(0, "white");
          gradient.addColorStop(0.4, "white");
          gradient.addColorStop(0.4, currentUsers[i].color);
          gradient.addColorStop(1, "black");

          ctx.fillStyle = 'red';
          ctx.arc(
            currentUsers[i].x,
            currentUsers[i].y,
            currentUsers[i].radius,
            Math.PI * 2,
            false
          );
          ctx.fill();
        }
      });

      socket.on("PlayersMoving", function (players) {
        ctx.globalCompositeOperation = "source-over";
        //Lets reduce the opacity of the BG paint to give the final touch
        ctx.clearRect(0,0,W,H)
        //Lets blend the particle with the BG
        ctx.globalCompositeOperation = "lighter";

        var players = players;
        var i = 0;
        function allPlayers() {
          for (i; i < players.length; i++) {
            ctx.beginPath();

            //Time for some colors
            var gradient = ctx.createRadialGradient(
              players[i].x,
              players[i].y,
              0,
              players[i].x,
              players[i].y,
              players[i].radius
            );
            gradient.addColorStop(0.5, "white");
            gradient.addColorStop(0.5, players[i].color);
            gradient.addColorStop(1, "black");

            ctx.fillStyle = 'red';
            ctx.arc(
              players[i].x,
              players[i].y,
              players[i].radius,
              Math.PI * 2,
              false
            );
            
            if (players[i].x + players[i].radius > canvas.width) {
              players.x = canvas.width - players.radius
            }
            
            if (players[i].y + players[i].radius > canvas.height) {
              players[i].y = canvas.height - players[i].radius
            }
            
            if (players[i].x < 0) {
              players[i].x = 0; players[i].speed = 0
            }
            
            if (players[i].y < 0) {
              players[i].y = 0; players[i].speed = 0
            }
            ctx.fill();
          }
        }
        allPlayers();
      });
    </script>
  </body>
</html>
